#!/bin/bash
# Restore old schema format in templates by extracting from committed docs

set -e

echo "Restoring old schema format in templates..."

# Function to replace schema in template with committed version
replace_schema() {
  local template_file="$1"
  local doc_file="$2"
  
  if [ ! -f "$template_file" ]; then
    echo "Warning: Template $template_file not found"
    return
  fi
  
  # Check if template contains SchemaMarkdown
  if ! grep -q '{{ .SchemaMarkdown' "$template_file"; then
    return
  fi
  
  # Extract schema section from committed doc (from ## Argument Reference to end of file)
  local schema_file="/tmp/schema_$$_$(basename "$doc_file")"
  git show HEAD:"$doc_file" 2>/dev/null | sed -n '/## Argument Reference/,$p' > "$schema_file" || {
    echo "Warning: No Argument Reference section found in $doc_file"
    rm -f "$schema_file"
    return
  }
  
  if [ ! -s "$schema_file" ]; then
    echo "Warning: Empty schema section in $doc_file"
    rm -f "$schema_file"
    return
  fi
  
  # Find the line number where {{ .SchemaMarkdown appears
  local schema_line
  schema_line=$(grep -n '{{ .SchemaMarkdown' "$template_file" | cut -d: -f1 | head -1)
  
  if [ -z "$schema_line" ]; then
    rm -f "$schema_file"
    return
  fi
  
  # Keep everything before the SchemaMarkdown line
  head -n $((schema_line - 1)) "$template_file" > "$template_file.tmp"
  
  # Add blank line and schema content
  echo "" >> "$template_file.tmp"
  cat "$schema_file" >> "$template_file.tmp"
  
  mv "$template_file.tmp" "$template_file"
  rm -f "$schema_file"
  echo "Updated: $template_file"
}

# Process all data source templates
for template in templates/data-sources/*.md.tmpl; do
  filename=$(basename "$template" .md.tmpl)
  doc_file="docs/data-sources/${filename}.md"
  replace_schema "$template" "$doc_file"
done

# Process all resource templates
for template in templates/resources/*.md.tmpl; do
  filename=$(basename "$template" .md.tmpl)
  doc_file="docs/resources/${filename}.md"
  replace_schema "$template" "$doc_file"
done

echo "Schema format restoration complete."
